<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stock Manager Pro V19</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2422/2422266.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: white; margin: 0; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        .pt-safe-top { padding-top: max(20px, env(safe-area-inset-top, 20px)); }
        .pb-safe-bottom { padding-bottom: max(20px, env(safe-area-inset-bottom, 20px)); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #loader { position: fixed; inset: 0; background: #0f172a; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s; }
        .spinner { width: 32px; height: 32px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #6366f1; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .anim-fade { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        input[type="date"] { color-scheme: dark; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); }
        .btn-active:active { transform: scale(0.95); }
        .search-scroll::-webkit-scrollbar { width: 4px; }
        .search-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <div id="loader-status" style="margin-top:15px; font-size:12px; color:#94a3b8;">V19.0 核心啟動中...</div>
    </div>
    <div id="app"></div>

    <script type="module">
        import { h, render } from 'https://esm.sh/preact@10.19.3';
        import { useState, useMemo, useEffect, useRef, useCallback } from 'https://esm.sh/preact@10.19.3/hooks';
        import { memo } from 'https://esm.sh/preact@10.19.3/compat';
        import htm from 'https://esm.sh/htm@3.1.1';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, setDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const html = htm.bind(h);

        // ==========================================
        //  配置區 (鎖定：小寫 j)
        // ==========================================
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyD1k6xVEja5RSYdbuYqBMgXvH99uvJ8hwI", 
            authDomain: "stock-manager-a6176.firebaseapp.com",
            projectId: "stock-manager-a6176",
            storageBucket: "stock-manager-a6176.firebasestorage.app",
            messagingSenderId: "792066701006",
            appId: "1:792066701006:web:1312cde0e3c1572c7d029f",
            measurementId: "G-RG1BMS697M"
        };
        const activeProjectId = FIREBASE_CONFIG.projectId;
        const GEMINI_API_KEY = ""; 

        // 全域格式化
        const fNum = (n) => new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(Number(n) || 0);
        const fInt = (n) => new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(Number(n) || 0);

        // --- ICON 元件 ---
        const Icon = memo(({ name, size = 18, className = "" }) => {
            const paths = {
                wallet: html`<path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4" />`,
                pie: html`<path d="M21.21 15.89A10 10 0 1 1 8 2.83M22 12A10 10 0 0 0 12 2v10z" />`,
                plus: html`<path d="M12 5v14M5 12h14" />`,
                x: html`<path d="M18 6 6 18M6 6l12 12" />`,
                trash: html`<polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />`,
                globe: html`<circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>`,
                cloud: html`<path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M17.5 19a5.5 5.5 0 0 0 2-10.5c0-4.418-3.582-8-8-8s-8 3.582-8 8a5.5 5.5 0 0 0 2 10.5"/>`,
                sparkles: html`<path d="m12 3 1.912 5.813a2 2 0 0 0 1.275 1.275L21 12l-5.813 1.912a2 2 0 0 0-1.275 1.275L12 21l-1.912-5.813a2 2 0 0 0-1.275-1.275L3 12l5.813-1.912a2 2 0 0 0 1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M3 5h4"/><path d="M21 17v4"/><path d="M19 19h4"/>`,
                pencil: html`<path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />`,
                download: html`<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>`,
                upload: html`<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>`,
                loader: html`<path d="M21 12a9 9 0 1 1-6.219-8.56" />`,
                alert: html`<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>`,
                copy: html`<rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>`,
                settings: html`<circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>`
            };
            return html`<svg xmlns="http://www.w3.org/2000/svg" width=${size} height=${size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class=${className}>${paths[name] || html`<circle cx="12" cy="12" r="10" />`}</svg>`;
        });

        // --- Gemini AI ---
        const callGemini = async (prompt, systemPrompt = "你是一位資深的股市分析師，請用繁體中文回應。") => {
            const apiKey = GEMINI_API_KEY;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } })
                });
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "AI 忙碌中。";
            } catch (e) { return "AI 連線異常。"; }
        };

        const AIModal = memo(({ isOpen, onClose, content, loading, title }) => {
            if (!isOpen) return null;
            return html`
                <div class="fixed inset-0 modal-overlay z-[800] flex items-center justify-center p-4 animate-fade-in text-white">
                    <div class="bg-slate-900 w-full max-w-lg rounded-2xl border border-slate-800 shadow-2xl flex flex-col max-h-[85vh]">
                        <div class="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900 rounded-t-2xl sticky top-0">
                            <h3 class="font-bold text-indigo-400 flex items-center gap-2"><${Icon} name="sparkles" size=${18} /> ${title}</h3>
                            <button onClick=${onClose} class="p-2 text-slate-400 hover:text-white transition-colors"><${Icon} name="x" /></button>
                        </div>
                        <div class="p-6 overflow-y-auto prose no-scrollbar text-slate-300">
                            ${loading ? html`<div class="flex flex-col items-center py-10 space-y-4"><div class="spinner"></div><div class="text-slate-500 text-sm animate-pulse text-center">AI 正在深度分析數據中...</div></div>` : html`<div dangerouslySetInnerHTML=${{ __html: content.replace(/\n/g, '<br/>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') }}></div>`}
                        </div>
                        <div class="p-4 border-t border-slate-800 text-center bg-slate-900 rounded-b-2xl">
                            <button onClick=${onClose} class="bg-slate-800 hover:bg-slate-700 px-8 py-2.5 rounded-xl text-sm font-bold text-white transition-all active:scale-95">關閉</button>
                        </div>
                    </div>
                </div>
            `;
        });

        // --- 備份碼處理視窗 (新增：替代檔案匯入方案) ---
        const BackupModal = memo(({ isOpen, onClose, onImport, initialData }) => {
            const [text, setText] = useState('');
            const [mode, setMode] = useState('import'); // import | export
            
            useEffect(() => {
                if (isOpen && initialData) {
                    setMode('export');
                    setText(JSON.stringify(initialData, null, 2));
                } else {
                    setMode('import');
                    setText('');
                }
            }, [isOpen, initialData]);

            const handleCopy = () => {
                navigator.clipboard.writeText(text);
                alert("已複製到剪貼簿！");
            };

            const handlePasteAndImport = () => {
                try {
                    const json = JSON.parse(text);
                    onImport(json);
                } catch (e) {
                    alert("格式錯誤：請確保您貼上的是正確的 JSON 備份碼。");
                }
            };

            if (!isOpen) return null;

            return html`
                <div class="fixed inset-0 modal-overlay z-[900] flex items-center justify-center p-4 animate-fade-in text-white">
                    <div class="bg-slate-900 w-full max-w-lg rounded-2xl border border-slate-800 shadow-2xl flex flex-col max-h-[85vh]">
                        <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                            <h3 class="font-bold text-white text-lg">${mode==='export'?'備份碼 (導出)':'貼上備份碼 (導入)'}</h3>
                            <button onClick=${onClose} class="p-2 text-slate-400"><${Icon} name="x"/></button>
                        </div>
                        <div class="p-4 flex-1 overflow-hidden flex flex-col">
                            <p class="text-xs text-slate-400 mb-2">${mode==='export'?'請複製下方代碼並保存在安全的地方：':'請將您的備份代碼貼在下方：'}</p>
                            <textarea value=${text} onInput=${e=>setText(e.target.value)} class="w-full flex-1 bg-slate-950 border border-slate-700 rounded-xl p-3 text-xs font-mono text-slate-300 focus:border-indigo-500 outline-none resize-none" style="min-height: 200px;"></textarea>
                        </div>
                        <div class="p-4 border-t border-slate-800 flex gap-3">
                            ${mode === 'export' ? html`
                                <button onClick=${handleCopy} class="flex-1 bg-indigo-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-all"><${Icon} name="copy" size=${16}/> 複製代碼</button>
                            ` : html`
                                <button onClick=${handlePasteAndImport} class="flex-1 bg-green-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-all"><${Icon} name="download" size=${16}/> 執行還原</button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        });

        // --- 核心組件：PortfolioItem ---
        const PortfolioItem = memo(({ stock, onEditPrice, onEditCorrection, onAnalyzeStock }) => {
            return html`
                <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800 mb-4 shadow-xl relative group anim-fade overflow-hidden">
                    <div class="flex justify-between items-start mb-5">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-xl bg-indigo-500/10 text-indigo-400 flex items-center justify-center font-bold text-lg border border-indigo-500/20 font-mono shadow-inner">${stock.code.substring(0,2)}</div>
                            <div>
                                <div class="font-bold text-lg text-white flex items-center gap-2">${stock.code}<button onClick=${() => onAnalyzeStock(stock.code)} class="text-indigo-400 p-1 bg-indigo-400/10 rounded transition-all active:scale-90"><${Icon} name="sparkles" size=${14}/></button></div>
                                <div class="text-[11px] text-slate-500 truncate w-32 font-bold uppercase tracking-tight">${stock.name || '---'}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center justify-end gap-1 bg-slate-950 px-3 py-2 rounded-xl border border-slate-800 shadow-inner">
                                <span class="text-xs text-slate-500 font-bold">$</span>
                                <input type="number" step="0.01" value=${stock.price} onInput=${e => onEditPrice(stock.code, e.target.value)} class="bg-transparent text-right font-bold text-xl w-24 outline-none ${stock.price > stock.avg ? 'text-red-400' : 'text-green-400'}"/>
                            </div>
                            <div class="text-[9px] text-slate-600 font-bold mt-1 uppercase tracking-widest">市場現價</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-4 text-center">
                        <div class="bg-slate-800/30 p-3 rounded-xl border border-slate-700/30 relative">
                            <button onClick=${() => onEditCorrection(stock)} class="absolute -top-2 -right-1 bg-slate-800 text-slate-500 p-1 rounded-full border border-slate-700 hover:text-indigo-400"><${Icon} name="pencil" size=${10}/></button>
                            <div class="text-[10px] text-slate-500 font-bold uppercase mb-1">單位成本</div>
                            <div class="text-sm font-bold text-slate-300 font-mono">$${fNum(stock.avg)}</div>
                        </div>
                        <div class="bg-slate-800/30 p-3 rounded-xl border border-slate-800/50">
                            <div class="text-[10px] text-slate-500 font-bold uppercase mb-1">總成本</div>
                            <div class="text-sm font-bold text-slate-300 font-mono">$${fInt(stock.cost)}</div>
                        </div>
                        <div class="bg-slate-800/30 p-3 rounded-xl border border-slate-800/50">
                            <div class="text-[10px] text-slate-500 font-bold uppercase mb-1">持有股數</div>
                            <div class="text-sm font-bold text-slate-300 font-mono">${fInt(stock.qty)}</div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center bg-slate-950/40 px-4 py-3 rounded-xl border border-slate-800/50">
                        <div class="text-xs text-slate-400 font-bold uppercase tracking-wider">未實現損益</div>
                        <div class="text-lg font-extrabold flex gap-3 ${stock.pl >= 0 ? 'text-red-400' : 'text-green-400'} tracking-tight">
                            <span>${stock.pl>=0?'+':''}${fInt(stock.pl)}</span>
                            <span class="text-xs px-2 py-1 rounded-lg bg-white/5 flex items-center font-bold">${stock.roi.toFixed(1)}%</span>
                        </div>
                    </div>
                </div>
            `;
        });

        // --- 主應用程式 ---
        const App = () => {
            const [fbStatus, setFbStatus] = useState('connecting'); 
            const [fbApp, setFbApp] = useState(null);
            const [fbUser, setFbUser] = useState(null);
            const [data, setData] = useState({ cashFlows: [], trades: [], prices: {}, corrections: {} });
            const [tab, setTab] = useState('portfolio');
            const [modal, setModal] = useState(null); // 'trade' | 'cash' | 'correction' | 'deleteConfirm' | 'backup'
            const [update, setUpdate] = useState({ loading: false, status: '' });
            const [ai, setAi] = useState({ open: false, loading: false, content: '', title: '' });
            const [backupData, setBackupData] = useState(null); // 用於導出的數據
            
            const [cashForm, setCashForm] = useState({ id: null, date: new Date().toISOString().split('T')[0], type: 'deposit', amount: '', note: '' });
            const [correctionForm, setCorrectionForm] = useState({ code: '', qty: '', avgCost: '' });
            const [tradeForm, setTradeForm] = useState({ id: null, date: new Date().toISOString().split('T')[0], code: '', name: '', type: 'buy', price: '', quantity: '', fee: 0 });
            
            const [search, setSearch] = useState({ loading: false, results: [] });
            const searchTimer = useRef(null);
            const searchAbort = useRef(null);
            const [pendingDelete, setPendingDelete] = useState({ type: '', id: '' });

            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        const appInstance = initializeApp(FIREBASE_CONFIG);
                        setFbApp(appInstance);
                        const auth = getAuth(appInstance);
                        onAuthStateChanged(auth, async (u) => {
                            if (u) { setFbUser(u); setFbStatus('connected'); }
                            else { await signInAnonymously(auth).catch(() => setFbStatus('error')); }
                        });
                    } catch (e) { setFbStatus('error'); }
                };
                initFirebase();
            }, []);

            useEffect(() => {
                if (fbStatus === 'connected' && fbUser && fbApp) {
                    const db = getFirestore(fbApp);
                    const base = `/artifacts/${activeProjectId}/users/${fbUser.uid}`;
                    const unsubCash = onSnapshot(collection(db, `${base}/cashFlows`), s => setData(p => ({...p, cashFlows: s.docs.map(d=>({id:d.id, ...d.data()}))})));
                    const unsubTrades = onSnapshot(collection(db, `${base}/trades`), s => setData(p => ({...p, trades: s.docs.map(d=>({id:d.id, ...d.data()}))})));
                    const unsubPrices = onSnapshot(doc(db, `${base}/settings/prices`), s => s.exists() && setData(p=>({...p, prices: s.data()})));
                    const unsubCorr = onSnapshot(doc(db, `${base}/settings/corrections`), s => s.exists() && setData(p=>({...p, corrections: s.data()})));
                    return () => { unsubCash(); unsubTrades(); unsubPrices(); unsubCorr(); };
                }
            }, [fbStatus, fbUser, fbApp]);

            const stats = useMemo(() => {
                let inv = {}, tIn = 0, tOut = 0;
                [...data.trades].sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(t => {
                    const amt = Number(t.price)*Number(t.quantity), fee = Number(t.fee)||0;
                    if(!inv[t.code]) inv[t.code] = {name: t.name||t.code, qty:0, cost:0, avg:0};
                    if(t.type==='buy') { inv[t.code].qty+=Number(t.quantity); inv[t.code].cost+=amt+fee; tOut+=amt+fee; }
                    else { const cp = inv[t.code].qty>0 ? inv[t.code].cost/inv[t.code].qty : 0; inv[t.code].qty-=Number(t.quantity); inv[t.code].cost-=cp*Number(t.quantity); tIn+=amt-fee; }
                    inv[t.code].avg = inv[t.code].qty>0.0001 ? inv[t.code].cost/inv[t.code].qty : 0;
                });
                Object.entries(data.corrections).forEach(([k,v]) => { if(inv[k]) { inv[k].qty=Number(v.qty); inv[k].avg=Number(v.avgCost); inv[k].cost=inv[k].qty*inv[k].avg; } });
                let princ = 0;
                data.cashFlows.forEach(c => { if(c.type==='deposit') princ+=Number(c.amount); else if(c.type==='withdraw') princ-=Number(c.amount); });
                const holdings = Object.entries(inv).filter(([_,i])=>i.qty>0.0001).map(([c,i]) => {
                    const p = data.prices[c] !== undefined ? data.prices[c] : i.avg;
                    const mv = p*i.qty;
                    return {...i, code:c, price:p, mktVal:mv, pl:mv-i.cost, roi:i.cost>0?((mv-i.cost)/i.cost)*100:0};
                });
                const sVal = holdings.reduce((s,h)=>s+h.mktVal,0), sCost = holdings.reduce((s,h)=>s+h.cost,0);
                const rawCash = princ+tIn-tOut, cash = Math.max(0,rawCash), assets = sVal+cash;
                return { holdings, princ, cash, sVal, sCost, assets, totalPL: assets-princ, totalROI: princ>0?(assets-princ)/princ*100:0, stockPL: sVal-sCost, stockROI: sCost>0?(sVal-sCost)/sCost*100:0 };
            }, [data]);

            // --- ✨ 極速搜尋 (TradingView Direct) ---
            const performSearch = async (q) => {
                if(!q || q.length < 1) return setSearch({loading:false, results:[]});
                if (searchAbort.current) searchAbort.current.abort();
                searchAbort.current = new AbortController();
                setSearch(p=>({...p, loading:true}));
                try {
                    const tvUrl = `https://symbol-search.tradingview.com/symbol_search/?text=${encodeURIComponent(q)}&hl=1`;
                    const res = await fetch(tvUrl, { signal: searchAbort.current.signal });
                    const list = await res.json();
                    setSearch({ loading:false, results: list.slice(0, 8) });
                } catch { setSearch({ loading:false, results:[] }); }
            };

            const handleSave = useCallback(async (type, item) => {
                if (!fbUser) return;
                setModal(null); 
                const db = getFirestore(fbApp);
                const base = `/artifacts/${activeProjectId}/users/${fbUser.uid}`;
                try {
                    if (type === 'prices' || type === 'corrections') await setDoc(doc(db, `${base}/settings/${type}`), item);
                    else if (item.id && typeof item.id === 'string' && item.id.length > 5) await updateDoc(doc(db, `${base}/${type}/${item.id}`), item);
                    else { const { id, ...clean } = item; await addDoc(collection(db, `${base}/${type}`), clean); }
                } catch (err) { console.error("Error", err); }
            }, [fbUser, fbApp]);

            const onTradeSubmit = () => handleSave('trades', tradeForm);
            const onCashSubmit = () => handleSave('cashFlows', cashForm);
            const onCorrectionSubmit = () => handleSave('corrections', {[correctionForm.code]:{qty:correctionForm.qty, avgCost:correctionForm.avgCost}});

            const triggerDelete = (type, id) => { setPendingDelete({ type, id }); setModal('deleteConfirm'); };
            const executeDelete = async () => {
                const { type, id } = pendingDelete; setModal(null);
                if (!fbUser || !id) return;
                try { await deleteDoc(doc(getFirestore(fbApp), `/artifacts/${activeProjectId}/users/${fbUser.uid}/${type}`, id)); } catch (err) { console.error(err); }
            };

            // --- ✨ 批量報價更新 (Yahoo Batch) ---
            const handleUpdatePrices = async () => {
                const stocks = stats.holdings.map(h=>h.code);
                if(!stocks.length) return;
                setUpdate({loading:true, status: '批量更新中...'});
                const newP = {...data.prices};
                
                // 批次 10 檔
                for(let i=0; i<stocks.length; i+=10) {
                    const batch = stocks.slice(i, i+10);
                    try {
                        const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${batch.join(',')}`;
                        // 使用 corsproxy.io (支援 Query String)
                        const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                        const json = await res.json();
                        json.quoteResponse?.result?.forEach(q => {
                            if(q.regularMarketPrice) newP[q.symbol] = q.regularMarketPrice;
                        });
                    } catch(e) { console.error(e); }
                }
                
                await handleSave('prices', newP);
                setUpdate({loading:false, status: ''});
            };

            // --- ✨ 備份碼導入/導出 ---
            const prepareExport = () => {
                const backup = { trades: data.trades, cashFlows: data.cashFlows, prices: data.prices, corrections: data.corrections };
                setBackupData(backup);
                setModal('backup');
            };

            const executeImport = async (json) => {
                if (!confirm("確定要導入備份？")) return;
                setUpdate({loading:true, status: '批次恢復中...'});
                setModal(null);
                
                const db = getFirestore(fbApp);
                const baseRoot = `artifacts/${activeProjectId}/users/${fbUser.uid}`;
                
                const runBatchUpload = async (type, items) => {
                    if(!items || items.length === 0) return;
                    const CHUNK = 400;
                    for (let i = 0; i < items.length; i += CHUNK) {
                        const batch = writeBatch(db);
                        items.slice(i, i + CHUNK).forEach(item => {
                            const {id, ...rest} = item;
                            // 關鍵：轉型
                            if(rest.price) rest.price = Number(rest.price);
                            if(rest.quantity) rest.quantity = Number(rest.quantity);
                            if(rest.amount) rest.amount = Number(rest.amount);
                            batch.set(doc(collection(db, `${baseRoot}/${type}`)), rest);
                        });
                        await batch.commit();
                    }
                };
                
                if(json.trades) await runBatchUpload('trades', json.trades);
                if(json.cashFlows) await runBatchUpload('cashFlows', json.cashFlows);
                if(json.prices) await setDoc(doc(db, `${baseRoot}/settings/prices`), json.prices);
                if(json.corrections) await setDoc(doc(db, `${baseRoot}/settings/corrections`), json.corrections);
                
                setUpdate({loading:false, status: ''});
                alert("✅ 備份還原成功！");
            };

            const runAI = async (p) => {
                setAi({ open: true, loading: true, content: '', title: 'AI 投資助理' });
                const res = await callGemini(p);
                setAi(prev => ({ ...prev, loading: false, content: res }));
            };

            useEffect(() => { if (fbStatus !== 'connecting') document.getElementById('loader').style.display='none'; }, [fbStatus]);

            const previewCost = (Number(tradeForm.price)*Number(tradeForm.quantity))+(tradeForm.type==='buy'?(Number(tradeForm.fee)||0):-(Number(tradeForm.fee)||0));
            const previewRemaining = stats.cash+(tradeForm.type==='buy'?-previewCost:previewCost);

            return html`
                <div class="pb-safe-bottom min-h-screen anim-fade overflow-x-hidden">
                    ${update.loading && html`<div class="fixed inset-0 bg-black/85 z-[999] flex flex-col items-center justify-center backdrop-blur-md animate-fade-in"><div class="spinner mb-6"></div><div class="text-indigo-400 font-bold">${update.status}</div></div>`}
                    <${AIModal} isOpen=${ai.open} onClose=${()=>setAi(prev=>({...prev, open:false}))} content=${ai.content} loading=${ai.loading} title=${ai.title} />
                    
                    <!-- 備份碼彈窗 -->
                    <${BackupModal} isOpen=${modal === 'backup'} onClose=${()=>setModal(null)} onImport=${executeImport} initialData=${backupData} />

                    <div class="bg-slate-900 px-5 pt-6 pb-4 rounded-b-3xl shadow-2xl border-b border-slate-800 relative text-white">
                        <div class="grid grid-cols-2 gap-6 mb-4">
                            <div><div class="text-slate-400 text-[10px] uppercase font-bold mb-1 flex items-center gap-1 tracking-widest font-bold"><${Icon} name="wallet" size=${10}/> 資金總淨值</div><div class="text-2xl font-bold tracking-tight font-bold">$${fNum(stats.assets)}</div><div class="mt-2 pt-2 border-t border-slate-800 text-xs text-slate-500 font-bold">投入本金 $${fInt(stats.princ)}<div class="font-bold font-bold ${stats.totalPL >= 0 ? 'text-indigo-400' : 'text-slate-400'}">${stats.totalPL>=0?'+':''}${fInt(stats.totalPL)} (${stats.totalROI.toFixed(1)}%)</div></div></div>
                            <div class="pl-6 border-l border-slate-800 font-bold"><div class="text-slate-400 text-[10px] uppercase font-bold mb-1 flex items-center gap-1 tracking-widest font-bold"><${Icon} name="pie" size=${10}/> 股票市值</div><div class="text-2xl font-bold tracking-tight font-bold">$${fNum(stats.sVal)}</div><div class="mt-2 pt-2 border-t border-slate-800 text-xs text-slate-500 font-bold">持倉成本 $${fInt(stats.sCost)}<div class="font-bold font-bold ${stats.stockPL >= 0 ? 'text-red-400' : 'text-green-400'}">${stats.stockPL>=0?'+':''}${fInt(stats.stockPL)} (${stats.stockROI.toFixed(1)}%)</div></div></div>
                        </div>
                        <div class="flex justify-between items-center h-6">
                            <div class="flex items-center gap-1 text-[9px] ${fbStatus==='connected' ? 'text-blue-400' : 'text-red-400'} font-extrabold tracking-widest font-bold"><${Icon} name=${fbStatus==='connected' ? 'cloud' : 'alert'} size=${9}/> ${fbStatus==='connected' ? '雲端已連線' : '連線中...'}</div>
                            <button onClick=${()=>runAI('分析資產組合概況：$' + stats.assets.toFixed(0))} class="bg-indigo-600/20 text-indigo-400 px-3 py-1 rounded-full border border-indigo-500/30 active:scale-95 shadow-lg flex items-center gap-1 font-bold font-bold"><${Icon} name="sparkles" size=${10}/><span class="text-[9px] font-bold">AI 智慧分析</span></button>
                        </div>
                    </div>

                    <div class="flex px-2 mt-2 sticky top-0 bg-slate-950/90 z-30 backdrop-blur-md border-b border-slate-800/50">
                        ${['portfolio', 'capital', 'transactions', 'settings'].map(t => html`<button key=${t} onClick=${() => setTab(t)} class="flex-1 py-3.5 text-xs font-bold transition-all ${tab === t ? 'border-b-2 border-indigo-500 text-indigo-400 scale-105' : 'text-slate-600'} font-bold">${t === 'portfolio' ? '持倉' : t === 'capital' ? '資金' : t === 'transactions' ? '紀錄' : '設定'}</button>`)}
                    </div>

                    <div class="p-4 space-y-4 pb-24 text-white">
                        ${tab === 'portfolio' && html`
                            <div class="space-y-4 animate-fade-in font-bold">
                                <button onClick=${handleUpdatePrices} disabled=${update.loading} class="w-full border border-slate-800 py-4 rounded-xl text-sm font-bold flex items-center justify-center gap-2 active:scale-95 bg-slate-900 text-indigo-400 shadow-lg"><${Icon} name="globe" size=${14}/> 批量更新現價 (v19)</button>
                                ${stats.holdings.map(s => html`<${PortfolioItem} key=${s.code} stock=${s} onAnalyzeStock=${(c)=>runAI('分析股票 ' + c)} onEditPrice=${(c,v)=>handleSave('prices', {...data.prices, [c]: parseFloat(v)||0})} onEditCorrection=${(s)=>{setCorrectionForm({code:s.code, qty:s.qty, avgCost:s.avgCost}); setModal('correction')}} />`)}
                            </div>
                        `}
                        ${tab === 'capital' && html`
                            <div class="space-y-4 anim-fade text-white font-bold">
                                <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800 flex justify-between items-center shadow-lg font-bold"><div><div class="text-slate-400 text-[10px] font-bold uppercase mb-1 tracking-widest font-bold">可用現金餘額</div><div class="text-3xl font-bold font-bold">$${fNum(stats.cash)}</div></div><button onClick=${()=>{setCashForm({id:null, date:new Date().toISOString().split('T')[0], type:'deposit', amount:'', note:''}); setModal('cash')}} class="bg-indigo-600 text-white px-5 py-3 rounded-xl text-xs font-bold flex items-center gap-1.5 active:scale-95 shadow-lg font-bold"><${Icon} name="plus" size=${16} /> 資金</button></div>
                                ${data.cashFlows.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(f => html`<div class="bg-slate-900 p-3 rounded-xl flex justify-between items-center border border-slate-800 group mb-2 font-bold"><div class="flex items-center gap-3 pl-1"><div class="p-2 rounded-full ${f.type==='deposit'?'bg-blue-500/10 text-blue-400':'bg-orange-500/10 text-orange-400'}"><${Icon} name=${f.type==='deposit'?'plus':'trash'} size=${18}/></div><div><div class="text-sm font-bold text-slate-200 font-bold">${f.note||'資金紀錄'}</div><div class="text-[10px] text-slate-500 font-bold">${f.date}</div></div></div><div class="flex items-center gap-3 pr-1 font-mono font-bold"><div class=${f.type==='deposit'?'text-blue-400':'text-orange-400'}>${f.type==='withdraw'?'-':'+'}${Number(f.amount).toLocaleString()}</div><div class="flex gap-1 border-l border-slate-800 pl-2 opacity-0 group-hover:opacity-100 transition-opacity font-bold"><button onClick=${()=>{setCashForm(f); setModal('cash')}} class="p-2 text-slate-500 hover:text-indigo-400 bg-slate-800 rounded-lg"><${Icon} name="pencil" size=${14}/></button><button onClick=${()=>triggerDelete('cashFlows', f.id)} class="p-2 text-slate-500 hover:text-red-400 bg-slate-800 rounded-lg"><${Icon} name="trash" size=${14}/></button></div></div></div>`)}
                            </div>
                        `}
                        ${tab === 'transactions' && html`
                            <div class="space-y-4 anim-fade text-white font-bold">
                                <button onClick=${()=>{setTradeForm({id:null, date:new Date().toISOString().split('T')[0], code:'', name:'', type:'buy', price:'', quantity:'', fee:0}); setModal('trade')}} class="w-full bg-slate-900 border border-slate-700 border-dashed text-indigo-400 py-4 rounded-xl text-sm font-bold active:scale-95 shadow-md font-bold">新增紀錄</button>
                                ${data.trades.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t => html`<div class="bg-slate-900 p-4 rounded-xl border border-slate-800 flex justify-between items-center group relative mb-2 font-bold"><div class="flex gap-3 text-white font-bold"><div class="text-[10px] font-bold px-2 py-1 rounded h-fit mt-0.5 min-w-[3.5em] text-center ${t.type==='buy'?'bg-red-500/10 text-red-400':'bg-green-500/10 text-green-400'}">${t.type==='buy'?'BUY':'SELL'}</div><div><div class="font-bold text-base font-bold">${t.code}</div><div class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">${t.date}</div></div></div><div class="text-right flex items-center gap-3 pr-1 text-white font-bold"><div><div class="text-sm font-bold font-bold">$${(t.price * t.quantity).toLocaleString()}</div><div class="text-[10px] text-slate-500 font-mono font-bold">$${t.price} x ${t.quantity}</div></div><div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity border-l border-slate-800 pl-3 font-bold"><button onClick=${()=>{setTradeForm(t); setModal('trade')}} class="p-1.5 text-slate-500 hover:text-indigo-400 bg-slate-800 rounded-lg font-bold"><${Icon} name="pencil" size=${14}/></button><button onClick=${()=>triggerDelete('trades', t.id)} class="p-1.5 text-slate-500 hover:text-red-400 bg-slate-800 rounded-lg font-bold"><${Icon} name="trash" size=${14}/></button></div></div></div>`)}
                            </div>
                        `}
                        ${tab === 'settings' && html`
                            <div class="space-y-4 animate-fade-in text-white font-bold">
                                <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-xl font-bold">
                                    <h3 class="font-bold mb-5 flex items-center gap-2 font-bold"><${Icon} name="settings" size=${18} class="text-indigo-400"/> 備份中心</h3>
                                    <div class="p-4 bg-slate-950 rounded-xl border border-slate-800 space-y-4 font-bold">
                                        <p class="text-xs text-slate-400 font-bold">使用備份碼進行設備間轉移。</p>
                                        <div class="grid grid-cols-2 gap-3">
                                            <button onClick=${prepareExport} class="bg-slate-800 hover:bg-slate-700 text-white py-3.5 rounded-xl text-sm font-bold active:scale-[0.98] shadow-lg flex justify-center items-center gap-2 border border-slate-700"><${Icon} name="copy" size=${16}/> 顯示備份碼</button>
                                            <button onClick=${()=>{setBackupData(null); setModal('backup')}} class="bg-indigo-600 hover:bg-indigo-500 text-white py-3.5 rounded-xl text-sm font-bold active:scale-[0.98] shadow-lg flex justify-center items-center gap-2"><${Icon} name="download" size=${16}/> 貼上還原</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `}
                    </div>

                    ${modal === 'trade' && html`<div class="fixed inset-0 modal-overlay z-[200] flex items-end justify-center p-4 sm:items-center animate-fade-in font-bold"><div class="bg-slate-900 w-full max-w-md rounded-2xl border border-slate-800 p-5 space-y-4 animate-slide-up shadow-2xl relative overflow-visible font-bold"><div class="flex justify-between items-center text-white font-bold"><h3 class="font-bold text-lg">${tradeForm.id?'修改':'新增'}交易</h3><button onClick=${()=>setModal(null)} class="p-2 text-slate-400 font-bold"><${Icon} name="x" size=${24}/></button></div><div class="flex bg-slate-800 p-1 rounded-xl shadow-inner font-bold"><button onClick=${()=>setTradeForm({...tradeForm, type:'buy'})} class="flex-1 py-2.5 text-sm font-bold rounded-lg ${tradeForm.type==='buy'?'bg-red-500 text-white shadow-lg font-bold':'text-slate-400'}">買入</button><button onClick=${()=>setTradeForm({...tradeForm, type:'sell'})} class="flex-1 py-2.5 text-sm font-bold rounded-lg ${tradeForm.type==='sell'?'bg-green-500 text-white shadow-lg font-bold':'text-slate-400'}">賣出</button></div><div class="relative z-[500] font-bold"><label class="text-[10px] text-slate-500 font-bold uppercase tracking-widest font-bold">標代碼 (極速搜尋)</label><input type="text" value=${tradeForm.code} onInput=${e=>{setTradeForm({...tradeForm, code:e.target.value.toUpperCase()}); if(searchTimer.current) clearTimeout(searchTimer.current); searchTimer.current = setTimeout(()=>performSearch(e.target.value), 300);}} class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 mt-1 text-white text-base outline-none uppercase shadow-inner font-bold"/>${search.loading && html`<div class="absolute right-3 bottom-3 animate-spin"><${Icon} name="loader" size=${18} class="text-indigo-400 font-bold"/></div>`}${search.results.length > 0 && html`<ul class="search-list-container">${search.results.map(s => html`<li onClick=${()=>{setTradeForm({...tradeForm, code: s.symbol, name: s.shortname || s.symbol}); setSearch({loading:false, results:[]})}} class="search-item text-white font-bold"><div class="flex justify-between font-bold"><span>${s.symbol}</span><span class="text-[9px] text-slate-400 uppercase font-bold">${s.exchDisp}</span></div><div class="text-[11px] text-slate-400 truncate font-bold">${s.shortname}</div></li>`)}</ul>`}</div><div class="grid grid-cols-2 gap-4 font-bold"><input type="date" value=${tradeForm.date} onInput=${e=>setTradeForm({...tradeForm, date:e.target.value})} class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-white text-sm outline-none shadow-inner font-bold"/><input type="number" step="0.01" placeholder="股數" value=${tradeForm.quantity} onInput=${e=>setTradeForm({...tradeForm, quantity:e.target.value})} class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-white text-sm outline-none shadow-inner font-bold"/></div><input type="number" step="0.01" placeholder="單價 (成本)" value=${tradeForm.price} onInput=${e=>setTradeForm({...tradeForm, price:e.target.value})} class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-white text-sm outline-none shadow-inner font-bold"/><button onClick=${onTradeSubmit} class="w-full bg-indigo-600 py-4 rounded-xl font-bold text-white active:scale-95 transition-all text-lg font-bold">確認儲存</button></div></div>`}

                    ${modal === 'cash' && html`<div class="fixed inset-0 modal-overlay z-[120] flex items-end justify-center p-4 sm:items-center animate-fade-in text-white font-bold"><div class="bg-slate-900 w-full max-w-md rounded-2xl border border-slate-800 p-5 space-y-4 shadow-2xl animate-slide-up font-bold"><div class="flex justify-between items-center font-bold"><h3 class="font-bold text-lg">${cashForm.id?'修改':'新增'}資金</h3><button onClick=${()=>setModal(null)} class="p-2 text-slate-400 font-bold"><${Icon} name="x" size=${18}/></button></div><div class="flex bg-slate-800 p-1 rounded-xl shadow-inner font-bold"><button onClick=${()=>setCashForm({...cashForm, type:'deposit'})} class="flex-1 py-2.5 text-sm font-bold rounded-lg ${cashForm.type==='deposit'?'bg-blue-600 text-white shadow-lg font-bold':'text-slate-400'}">入金</button><button onClick=${()=>setCashForm({...cashForm, type:'withdraw'})} class="flex-1 py-2.5 text-sm font-bold rounded-lg ${cashForm.type==='withdraw'?'bg-orange-600 text-white shadow-lg font-bold':'text-slate-400'}">出金</button></div><div class="space-y-3 font-bold"><input type="date" value=${cashForm.date} onInput=${e=>setCashForm({...cashForm, date:e.target.value})} class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-white text-sm outline-none shadow-inner font-bold"/><input type="number" placeholder="金額" value=${cashForm.amount} onInput=${e=>setCashForm({...cashForm, amount:e.target.value})} class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-white text-sm outline-none shadow-inner font-bold"/><input type="text" placeholder="備註" value=${cashForm.note} onInput=${e=>setCashForm({...cashForm, note:e.target.value})} class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-white text-sm outline-none shadow-inner font-bold"/></div><button onClick=${onCashSubmit} class="w-full bg-indigo-600 py-3.5 rounded-xl font-bold text-white active:scale-95 shadow-lg font-bold">確認儲存</button></div></div>`}

                    ${modal === 'correction' && html`<div class="fixed inset-0 modal-overlay z-[120] flex items-end justify-center p-4 sm:items-center animate-fade-in text-white font-bold"><div class="bg-slate-900 w-full max-w-md rounded-2xl border border-slate-800 p-5 space-y-4 shadow-2xl animate-slide-up font-bold"><div class="flex justify-between items-center font-bold"><h3 class="font-bold flex items-center gap-2 text-lg">修正: ${correctionForm.code}</h3><button onClick=${()=>setModal(null)} class="p-2 text-slate-400 font-bold"><${Icon} name="x"/></button></div><div class="space-y-3 font-bold"><input type="number" value=${correctionForm.qty} onInput=${e=>setCorrectionForm({...correctionForm, qty:e.target.value})} class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-white text-lg outline-none shadow-inner font-bold" placeholder="股數"/><input type="number" step="0.01" value=${correctionForm.avgCost} onInput=${e=>setCorrectionForm({...correctionForm, avgCost:e.target.value})} class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-white text-lg outline-none shadow-inner font-bold" placeholder="平均成本"/></div><button onClick=${onCorrectionSubmit} class="w-full bg-yellow-600 py-4 rounded-xl font-bold text-white shadow-lg active:scale-95 transition-all text-lg font-bold">確認修正</button></div></div>`}

                    ${modal === 'deleteConfirm' && html`<div class="fixed inset-0 modal-overlay z-[900] flex items-center justify-center p-6 animate-fade-in text-white font-bold"><div class="bg-slate-900 w-full max-w-sm rounded-3xl border border-red-900/30 p-8 space-y-6 shadow-2xl animate-slide-up font-bold"><div class="flex flex-col items-center text-center space-y-4 font-bold"><div class="w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center text-red-500 mb-2 shadow-inner border border-red-500/20 font-bold"><${Icon} name="trash" size=${40} /></div><h3 class="text-2xl font-bold tracking-tight text-white font-bold">確定要刪除嗎？</h3><p class="text-sm text-slate-400 font-bold">移除後雲端資料將永久消失。</p></div><div class="flex gap-4 font-bold"><button onClick=${()=>setModal(null)} class="flex-1 py-4 rounded-2xl bg-slate-800 text-white font-bold active:scale-95 border border-slate-700 font-bold">取消</button><button onClick=${executeDelete} class="flex-1 py-4 rounded-2xl bg-red-600 text-white font-bold active:scale-95 shadow-lg shadow-red-900/40 font-bold">確認刪除</button></div></div></div>`}
                </div>
            `;
        };

        render(html`<${App} />`, document.getElementById('app'));
    </script>
</body>
</html>
