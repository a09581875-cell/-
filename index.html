<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stock Manager Pro</title>
    <!-- iOS PWA 配置 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2422/2422266.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: white; margin: 0; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        .pt-safe-top { padding-top: max(20px, env(safe-area-inset-top, 20px)); }
        .pb-safe-bottom { padding-bottom: max(20px, env(safe-area-inset-bottom, 20px)); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #loader { position: fixed; inset: 0; background: #0f172a; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #6366f1; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .anim-fade { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        input[type="date"] { color-scheme: dark; }
    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <div id="loader-status" style="margin-top:15px; font-size:12px; color:#94a3b8;">啟動 V15.1 旗艦版...</div>
    </div>
    <div id="app"></div>

    <script type="module">
        import { h, render } from 'https://esm.sh/preact@10.19.3';
        import { useState, useMemo, useEffect, useRef, useCallback } from 'https://esm.sh/preact@10.19.3/hooks';
        import { memo } from 'https://esm.sh/preact@10.19.3/compat';
        import htm from 'https://esm.sh/htm@3.1.1';
        
        // --- Firebase SDK 11.6.1 ---
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, setDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const html = htm.bind(h);

        // ==========================================
        //  Firebase 配置 (與您的專案同步)
        // ==========================================
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyD1k6xVEJa5RSYdbuYqBMgXvH99uvJ8hwI",
            authDomain: "stock-manager-a6176.firebaseapp.com",
            projectId: "stock-manager-a6176",
            storageBucket: "stock-manager-a6176.firebasestorage.app",
            messagingSenderId: "792066701006",
            appId: "1:792066701006:web:1312cde0e3c1572c7d029f",
            measurementId: "G-RG1BMS697M"
        };
        const appId = FIREBASE_CONFIG.projectId;
        // ==========================================

        const Icon = memo(({ name, size = 18, className = "" }) => {
            const paths = {
                wallet: html`<path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4" />`,
                pie: html`<path d="M21.21 15.89A10 10 0 1 1 8 2.83M22 12A10 10 0 0 0 12 2v10z" />`,
                plus: html`<path d="M12 5v14M5 12h14" />`,
                x: html`<path d="M18 6 6 18M6 6l12 12" />`,
                edit: html`<path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />`,
                trash: html`<polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />`,
                globe: html`<circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1 4-10z"/>`,
                cloud: html`<path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M17.5 19a5.5 5.5 0 0 0 2-10.5c0-4.418-3.582-8-8-8s-8 3.582-8 8a5.5 5.5 0 0 0 2 10.5"/>`,
                loader: html`<path d="M21 12a9 9 0 1 1-6.219-8.56" />`,
                upload: html`<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>`,
                alert: html`<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>`,
                settings: html`<circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>`
            };
            return html`<svg xmlns="http://www.w3.org/2000/svg" width=${size} height=${size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class=${className}>${paths[name] || html`<circle cx="12" cy="12" r="10" />`}</svg>`;
        });

        // 多代理線路
        const fetchWithProxy = async (targetUrl, signal) => {
            const proxies = [
                url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
                url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`
            ];
            for (const createProxyUrl of proxies) {
                try {
                    const res = await fetch(createProxyUrl(targetUrl), { signal });
                    if (!res.ok) continue;
                    return await res.json();
                } catch (e) { if (signal?.aborted) throw e; continue; }
            }
            throw new Error('Proxy Fail');
        };

        const App = () => {
            const [fbStatus, setFbStatus] = useState('connecting'); // connecting | auth_ok | connected | error
            const [fbApp, setFbApp] = useState(null);
            const [fbUser, setFbUser] = useState(null);
            const [data, setData] = useState({ cashFlows: [], trades: [], prices: {}, corrections: {} });
            const [tab, setTab] = useState('portfolio');
            const [modal, setModal] = useState(null);
            const [search, setSearch] = useState({ loading: false, results: [] });
            const [update, setUpdate] = useState({ loading: false, status: '' });
            const [correctionForm, setCorrectionForm] = useState({ code: '', qty: '', avgCost: '' });
            const searchAbort = useRef(null);
            const searchTimer = useRef(null);

            // 1. 初始化 Firebase
            useEffect(() => {
                const init = async () => {
                    try {
                        const appInstance = initializeApp(FIREBASE_CONFIG);
                        setFbApp(appInstance);
                        const auth = getAuth(appInstance);
                        onAuthStateChanged(auth, (u) => {
                            if (u) { setFbUser(u); setFbStatus('auth_ok'); } 
                            else { signInAnonymously(auth).catch(() => setFbStatus('error')); }
                        });
                    } catch (e) { setFbStatus('error'); }
                };
                init();
            }, []);

            // 2. 登入後監聽資料
            useEffect(() => {
                if (fbStatus === 'auth_ok' && fbUser && fbApp) {
                    const db = getFirestore(fbApp);
                    const path = `/artifacts/${appId}/users/${fbUser.uid}`;
                    const unsubCash = onSnapshot(collection(db, `${path}/cashFlows`), s => {
                        setData(p => ({...p, cashFlows: s.docs.map(d=>({id:d.id, ...d.data()}))}));
                        setFbStatus('connected');
                    }, () => setFbStatus('error'));
                    const unsubTrades = onSnapshot(collection(db, `${path}/trades`), s => setData(p => ({...p, trades: s.docs.map(d=>({id:d.id, ...d.data()}))})));
                    const unsubPrices = onSnapshot(doc(db, `${path}/settings/prices`), s => s.exists() && setData(p=>({...p, prices: s.data()})));
                    const unsubCorr = onSnapshot(doc(db, `${path}/settings/corrections`), s => s.exists() && setData(p=>({...p, corrections: s.data()})));
                    return () => { unsubCash(); unsubTrades(); unsubPrices(); unsubCorr(); };
                }
            }, [fbStatus, fbUser, fbApp]);

            // 3. 核心計算
            const stats = useMemo(() => {
                let inv = {}, tIn = 0, tOut = 0;
                [...data.trades].sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(t => {
                    const amt = Number(t.price)*Number(t.quantity), fee = Number(t.fee)||0;
                    if(!inv[t.code]) inv[t.code] = {name: t.name||t.code, qty:0, cost:0, avg:0};
                    if(t.type==='buy') { inv[t.code].qty+=Number(t.quantity); inv[t.code].cost+=amt+fee; tOut+=amt+fee; }
                    else { const cp = inv[t.code].qty>0 ? inv[t.code].cost/inv[t.code].qty : 0; inv[t.code].qty-=Number(t.quantity); inv[t.code].cost-=cp*Number(t.quantity); tIn+=amt-fee; }
                    inv[t.code].avg = inv[t.code].qty>0.0001 ? inv[t.code].cost/inv[t.code].qty : 0;
                });
                Object.entries(data.corrections).forEach(([k,v]) => { if(inv[k]) { inv[k].qty=Number(v.qty); inv[k].avg=Number(v.avgCost); inv[k].cost=inv[k].qty*inv[k].avg; } });
                let princ = 0;
                data.cashFlows.forEach(c => { if(c.type==='deposit') princ+=Number(c.amount); else if(c.type==='withdraw') princ-=Number(c.amount); });
                const holdings = Object.entries(inv).filter(([_,i])=>i.qty>0.0001).map(([c,i]) => {
                    const p = data.prices[c] !== undefined ? data.prices[c] : i.avg;
                    const mv = p*i.qty;
                    return {...i, code:c, price:p, mktVal:mv, pl:mv-i.cost, roi:i.cost>0?(mv-i.cost)/i.cost*100:0};
                });
                const sVal = holdings.reduce((s,h)=>s+h.mktVal,0), sCost = holdings.reduce((s,h)=>s+h.cost,0);
                const rawCash = princ+tIn-tOut, cash = Math.max(0,rawCash), assets = sVal+cash;
                return { holdings, princ, cash, sVal, sCost, assets, totalPL: assets-princ, totalROI: princ>0?(assets-princ)/princ*100:0, stockPL: sVal-sCost, stockROI: sCost>0?(sVal-sCost)/sCost*100:0, isReinv: rawCash < 0, reinvAmt: rawCash < 0 ? Math.abs(rawCash) : 0 };
            }, [data]);

            // CRUD & Actions
            const handleSave = useCallback(async (type, item, silent = false) => {
                if (!fbUser) return;
                const db = getFirestore(fbApp);
                const path = `/artifacts/${appId}/users/${fbUser.uid}`;
                try {
                    if (type === 'prices' || type === 'corrections') await setDoc(doc(db, `${path}/settings/${type}`), item);
                    else if (item.id && typeof item.id === 'string' && item.id.length > 5) await updateDoc(doc(db, `${path}/${type}/${item.id}`), item);
                    else await addDoc(collection(db, `${path}/${type}`), item);
                } catch (err) { console.error(err); }
                if (!silent) setModal(null);
            }, [fbUser, fbApp]);

            const handleDelete = async (type, id) => {
                if(!confirm('確定刪除？') || !fbUser) return;
                await deleteDoc(doc(getFirestore(fbApp), `/artifacts/${appId}/users/${fbUser.uid}/${type}`, id));
            };

            const handleUpdatePrices = async () => {
                const stocks = stats.holdings.map(h=>h.code);
                if(!stocks.length) return;
                setUpdate({loading:true, status:'更新中...'});
                const newP = {...data.prices};
                for(let i=0; i<stocks.length; i+=5) {
                    const batch = stocks.slice(i, i+5);
                    await Promise.all(batch.map(async (c) => {
                        try {
                            const ctl = new AbortController(); setTimeout(()=>ctl.abort(), 6000);
                            const url = `https://query1.finance.yahoo.com/v8/finance/chart/${c}?interval=1d&range=1d&_t=${Date.now()}`;
                            const json = await fetchWithProxy(url, ctl.signal);
                            const p = json.chart?.result?.[0]?.meta?.regularMarketPrice;
                            if(p) newP[c] = p;
                        } catch {}
                    }));
                }
                await handleSave('prices', newP, true);
                setUpdate({loading:false, status:''});
            };

            // 極速批次匯入
            const handleImport = async (e) => {
                const file = e.target.files[0];
                if (!file || !fbUser) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const json = JSON.parse(event.target.result);
                        if (!confirm("即將使用 Batch 模式批次同步至雲端。")) return;
                        setUpdate({loading:true, status: '批次同步中，請勿離開...'});
                        const db = getFirestore(fbApp);
                        const base = `/artifacts/${appId}/users/${fbUser.uid}`;
                        const runBatch = async (type, items) => {
                            if (!items) return;
                            let batch = writeBatch(db);
                            let count = 0;
                            for (const item of items) {
                                const {id, ...rest} = item;
                                batch.set(doc(collection(db, `${base}/${type}`)), rest);
                                if (++count >= 50) { await batch.commit(); batch = writeBatch(db); count = 0; }
                            }
                            await batch.commit();
                        };
                        await runBatch('trades', json.trades);
                        await runBatch('cashFlows', json.cashFlows);
                        if (json.corrections) await setDoc(doc(db, `${base}/settings/corrections`), json.corrections);
                        alert("✅ 匯入成功！");
                    } catch (err) { alert("❌ 失敗"); }
                    setUpdate({loading:false, status: ''});
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            useEffect(() => {
                if (fbStatus !== 'connecting') {
                    const l = document.getElementById('loader');
                    if(l) { l.style.opacity=0; setTimeout(()=>l.remove(), 500); }
                }
            }, [fbStatus]);

            const fNum = n => new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
            const fInt = n => new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(n);

            return html`
                <div class="pb-safe-bottom min-h-screen anim-fade overflow-x-hidden">
                    ${update.loading && html`<div class="fixed inset-0 bg-black/85 z-[100] flex flex-col items-center justify-center backdrop-blur-md animate-fade-in"><div class="spinner mb-6"></div><div class="text-indigo-400 font-bold tracking-widest text-lg">${update.status}</div></div>`}
                    
                    <div class="bg-slate-900 px-5 pt-6 pb-4 rounded-b-3xl shadow-2xl border-b border-slate-800 relative">
                        <div class="grid grid-cols-2 gap-6 mb-4">
                            <div>
                                <div class="text-slate-400 text-[10px] font-bold mb-1 flex items-center gap-1"><${Icon} name="wallet" size=${10}/> 資金總淨值</div>
                                <div class="text-2xl font-bold tracking-tight">$${fNum(stats.assets)}</div>
                                <div class="mt-2 pt-2 border-t border-slate-800 text-xs text-slate-500">
                                    投入本金 $${fInt(stats.princ)}
                                    <div class="font-bold ${stats.totalPL >= 0 ? 'text-indigo-400' : 'text-slate-400'}">${stats.totalPL>=0?'+':''}${fInt(stats.totalPL)} (${stats.totalROI.toFixed(1)}%)</div>
                                </div>
                            </div>
                            <div class="pl-6 border-l border-slate-800">
                                <div class="text-slate-400 text-[10px] font-bold mb-1 flex items-center gap-1"><${Icon} name="pie" size=${10}/> 股票市值</div>
                                <div class="text-2xl font-bold tracking-tight">$${fNum(stats.sVal)}</div>
                                <div class="mt-2 pt-2 border-t border-slate-800 text-xs text-slate-500">
                                    持倉成本 $${fInt(stats.sCost)}
                                    <div class="font-bold ${stats.stockPL >= 0 ? 'text-red-400' : 'text-green-400'}">${stats.stockPL>=0?'+':''}${fInt(stats.stockPL)} (${stats.stockROI.toFixed(1)}%)</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center h-6">
                            <div class="flex items-center gap-1 text-[9px] ${fbStatus==='connected' ? 'text-blue-400' : 'text-red-400'}">
                                <${Icon} name=${fbStatus==='connected' ? 'cloud' : 'alert'} size=${9} class=${fbStatus==='connecting'?'animate-spin':''}/> 
                                ${fbStatus==='connected' ? '雲端同步中' : fbStatus==='error' ? '連線錯誤 (請檢查規則與登入)' : '連線中...'}
                            </div>
                            ${stats.isReinv && html`<div class="bg-indigo-500/10 rounded-full px-2 py-0.5 flex items-center gap-1 border border-indigo-500/20"><${Icon} name="zap" size=${10} class="text-indigo-400"/><span class="text-[9px] text-indigo-300">複利模式</span></div>`}
                        </div>
                    </div>

                    <div class="flex px-2 mt-2 sticky top-0 bg-slate-950/90 z-30 backdrop-blur-md border-b border-slate-800/50">
                        ${['portfolio', 'capital', 'transactions', 'settings'].map(t => html`
                            <button key=${t} onClick=${() => setTab(t)} class="flex-1 py-3 text-xs font-bold text-center border-b-2 transition-colors ${tab === t ? 'border-indigo-500 text-indigo-400' : 'border-transparent text-slate-600'}">
                                ${t === 'portfolio' ? '持倉' : t === 'capital' ? '資金' : t === 'transactions' ? '紀錄' : '設定'}
                            </button>
                        `)}
                    </div>

                    <div class="p-4 space-y-4 pb-24">
                        ${tab === 'portfolio' && html`
                            <div class="space-y-4 animate-fade-in">
                                <button onClick=${handleUpdatePrices} disabled=${update.loading} class="w-full border py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all active:scale-[0.98] ${update.loading ? 'bg-slate-800 border-slate-700 text-slate-500' : 'bg-slate-900 border-slate-800 hover:bg-slate-800 text-indigo-400 hover:border-indigo-500/50'}">
                                    <${Icon} name="globe" size=${14}/> 更新現價 (極速代理)
                                </button>
                                ${stats.holdings.map(s => html`
                                    <${PortfolioItem} key=${s.code} stock=${s} onEditPrice=${(c,v)=>handleSave('prices', {...data.prices, [c]: parseFloat(v)||0}, true)} onEditCorrection=${(s)=>{setCorrectionForm({code:s.code, qty:s.qty, avgCost:s.avgCost}); setModal('correction')}} />
                                `)}
                            </div>
                        `}
                        ${tab === 'capital' && html`
                            <div class="space-y-4 animate-fade-in">
                                <div class="bg-slate-900 p-4 rounded-xl border border-slate-800 flex justify-between items-center shadow-lg">
                                    <div><div class="text-slate-400 text-xs mb-1">可用現金餘額</div><div class="text-2xl font-bold">$${fNum(stats.cash)}</div></div>
                                    <button onClick=${()=>setModal('cash')} class="bg-indigo-600 text-white px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-1.5"><Plus size={14} /> 資金異動</button>
                                </div>
                                ${data.cashFlows.map(f => html`
                                    <div key=${f.id} class="bg-slate-900 p-3 rounded-lg flex justify-between items-center border border-slate-800 group relative overflow-hidden">
                                        <div class="flex items-center gap-3 pl-2">
                                            <div class="p-2 rounded-full ${f.type==='deposit' ? 'bg-blue-500/10 text-blue-400' : 'bg-orange-500/10 text-orange-400'}"><${Icon} name=${f.type==='deposit'?'plus':'trash'} size=${18}/></div>
                                            <div><div class="text-sm font-bold text-slate-200">${f.note||(f.type==='deposit'?'入金':'出金')}</div><div class="text-xs text-slate-500">${f.date}</div></div>
                                        </div>
                                        <div class="flex items-center gap-3 pr-2"><div class="font-mono font-bold ${f.type==='deposit'?'text-blue-400':'text-orange-400'}">${f.type==='withdraw'?'-':'+'}${fNum(f.amount)}</div><button onClick=${()=>handleDelete('cashFlows', f.id)} class="p-2 text-slate-700 hover:text-red-400"><${Icon} name="trash" size=${14}/></button></div>
                                    </div>
                                `)}
                            </div>
                        `}
                        ${tab === 'transactions' && html`
                            <div class="space-y-4 animate-fade-in">
                                <button onClick=${()=>setModal('trade')} class="w-full bg-slate-900 border border-slate-700 border-dashed text-indigo-400 py-3 rounded-xl text-sm font-bold flex justify-center gap-2 transition-all active:scale-[0.98]"><Plus size={16} /> 新增交易</button>
                                ${data.trades.map(t => html`
                                    <div key=${t.id} class="bg-slate-900 p-3 rounded-lg border border-slate-800 flex justify-between items-center group relative">
                                        <div class="flex gap-3 pl-2">
                                            <div class="text-[10px] font-bold px-2 py-1 rounded h-fit mt-0.5 ${t.type==='buy'?'bg-red-500/10 text-red-400':'bg-green-500/10 text-green-400'}">${t.type==='buy'?'BUY':'SELL'}</div>
                                            <div><div class="font-bold text-slate-200">${t.code}</div><div class="text-xs text-slate-500">${t.date}</div></div>
                                        </div>
                                        <div class="text-right flex items-center gap-3 pr-2"><div><div class="text-sm font-bold text-slate-200">$${fNum(t.price * t.quantity)}</div><div class="text-xs text-slate-500">$${fNum(t.price)} x ${fNum(t.quantity)}</div></div><button onClick=${()=>handleDelete('trades', t.id)} class="p-2 text-slate-700 hover:text-red-400"><${Icon} name="trash" size=${14}/></button></div>
                                    </div>
                                `)}
                            </div>
                        `}
                        ${tab === 'settings' && html`
                            <div class="space-y-4 animate-fade-in">
                                <div class="bg-slate-900 p-5 rounded-xl border border-slate-800">
                                    <h3 class="font-bold mb-4 flex items-center gap-2 text-white"><${Icon} name="settings" size=${18} class="text-indigo-400"/> 系統管理</h3>
                                    <div class="p-4 bg-slate-950 rounded-lg border border-slate-800 space-y-4 shadow-inner">
                                        <p class="text-xs text-slate-400 leading-relaxed font-medium">匯入舊備份：系統將使用 Batch 模式高速將資料寫入雲端。</p>
                                        <label class="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3.5 rounded-xl text-sm font-bold flex justify-center items-center gap-2 cursor-pointer transition-all active:scale-[0.98] shadow-lg shadow-indigo-900/30">
                                            <${Icon} name="upload" size=${16}/> 匯入並同步至雲端
                                            <input type="file" accept=".json" onChange=${handleImport} class="hidden" />
                                        </label>
                                    </div>
                                </div>
                            </div>
                        `}
                    </div>

                    ${modal === 'trade' && html`<${TradeModal} isOpen=${true} onClose=${()=>setModal(null)} onSubmit=${(f)=>handleSave('trades', f)} accountSummary=${stats} />`}

                    ${modal === 'cash' && html`
                        <div class="fixed inset-0 bg-black/80 z-50 flex items-end justify-center p-4 sm:items-center">
                            <div class="bg-slate-900 w-full max-w-md rounded-2xl border border-slate-800 p-5 space-y-4 animate-slide-up shadow-2xl">
                                <div class="flex justify-between items-center"><h3 class="font-bold text-white">資金異動</h3><button onClick=${()=>setModal(null)}><${Icon} name="x" class="text-slate-400"/></button></div>
                                <div class="flex bg-slate-800 p-1 rounded-xl"><button onClick=${()=>setForms(p=>({...p, cash:{...p.cash, type:'deposit'}}))} class="flex-1 py-2 text-sm font-bold rounded-lg ${forms.cash.type==='deposit'?'bg-blue-600 text-white shadow-lg':'text-slate-400'}">入金</button><button onClick=${()=>setForms(p=>({...p, cash:{...p.cash, type:'withdraw'}}))} class="flex-1 py-2 text-sm font-bold rounded-lg ${forms.cash.type==='withdraw'?'bg-orange-600 text-white shadow-lg':'text-slate-400'}">出金</button></div>
                                <input type="date" value=${forms.cash.date} onInput=${e=>setForms(p=>({...p, cash:{...p.cash, date:e.target.value}}))} class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-white text-sm outline-none"/>
                                <input type="number" placeholder="金額" value=${forms.cash.amount} onInput=${e=>setForms(p=>({...p, cash:{...p.cash, amount:e.target.value}}))} class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-white text-sm outline-none"/>
                                <input type="text" placeholder="備註" value=${forms.cash.note} onInput=${e=>setForms(p=>({...p, cash:{...p.cash, note:e.target.value}}))} class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-white text-sm outline-none"/>
                                <button onClick=${()=>handleSave('cashFlows', forms.cash)} class="w-full bg-indigo-600 py-3.5 rounded-xl font-bold active:scale-[0.98] transition-all shadow-lg">確認儲存</button>
                            </div>
                        </div>
                    `}

                    ${modal === 'correction' && html`
                        <div class="fixed inset-0 bg-black/80 z-50 flex items-end justify-center p-4 sm:items-center">
                            <div class="bg-slate-900 w-full max-w-md rounded-2xl border border-slate-800 p-5 space-y-4 animate-slide-up shadow-2xl">
                                <div class="flex justify-between items-center"><h3 class="font-bold text-white">修正數據: ${correctionForm.code}</h3><button onClick=${()=>setModal(null)}><${Icon} name="x" class="text-slate-400"/></button></div>
                                <div class="space-y-1"><label class="text-xs text-slate-500">修正後總股數</label><input type="number" value=${correctionForm.qty} onInput=${e=>setCorrectionForm({...correctionForm, qty:e.target.value})} class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-white outline-none"/></div>
                                <div class="space-y-1"><label class="text-xs text-slate-500">修正後平均成本</label><input type="number" step="0.01" value=${correctionForm.avgCost} onInput=${e=>setCorrectionForm({...correctionForm, avgCost:e.target.value})} class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-white outline-none"/></div>
                                <button onClick=${()=>{handleSave('corrections', {[correctionForm.code]:{qty:correctionForm.qty, avgCost:correctionForm.avgCost}})}} class="w-full bg-yellow-600 py-3 rounded-xl font-bold active:scale-[0.98] transition-all shadow-lg">確認修正</button>
                            </div>
                        </div>
                    `}
                </div>
            `;
        };

        render(html`<${App} />`, document.getElementById('app'));
    </script>
</body>
</html>
