<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stock Manager</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2422/2422266.png">

    <!-- 核心庫 (使用 unpkg, 不加 crossorigin 以避免 iOS 錯誤) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #0f172a; color: white; -webkit-tap-highlight-color: transparent; user-select: none; font-family: -apple-system, sans-serif; }
        .pt-safe-top { padding-top: max(20px, env(safe-area-inset-top)); }
        .pb-safe-bottom { padding-bottom: max(20px, env(safe-area-inset-bottom)); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* 載入動畫 */
        #loader { position: fixed; inset: 0; background: #0f172a; display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #6366f1; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div></div>
    <div id="root"></div>

    <script type="text/babel">
        // 移除載入畫面
        window.onload = () => {
            const loader = document.getElementById('loader');
            if(loader) { loader.style.opacity = '0'; setTimeout(() => loader.remove(), 500); }
        };

        const { useState, useMemo, useEffect, useRef } = React;

        // --- 內建圖示 (SVG) - 解決 Icon 載入錯誤 ---
        const Icon = ({ name, className = "" }) => {
            const size = 18;
            const icons = {
                wallet: <path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4" />,
                pie: <path d="M21.21 15.89A10 10 0 1 1 8 2.83M22 12A10 10 0 0 0 12 2v10z" />,
                up: <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />,
                down: <polyline points="23 18 13.5 8.5 8.5 13.5 1 6" />,
                plus: <path d="M12 5v14M5 12h14" />,
                x: <path d="M18 6 6 18M6 6l12 12" />,
                search: <circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" />,
                edit: <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />,
                trash: <polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />,
                in: <circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4M12 16V8"/>,
                out: <circle cx="12" cy="12" r="10"/><path d="m8 12 4 4 4-4M12 8v8"/>,
                zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />,
                save: <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>,
                globe: <circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>,
                check: <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        // --- 主程式邏輯 ---
        const App = () => {
            // 初始化資料 (從 LocalStorage)
            const [data, setData] = useState(() => {
                try {
                    const saved = localStorage.getItem('stock_app_db');
                    return saved ? JSON.parse(saved) : { cashFlows: [], trades: [], prices: {}, corrections: {} };
                } catch { return { cashFlows: [], trades: [], prices: {}, corrections: {} }; }
            });

            const [tab, setTab] = useState('portfolio');
            const [modal, setModal] = useState(null); // 'trade' | 'cash' | 'correction'
            const [forms, setForms] = useState({
                trade: { date: new Date().toISOString().split('T')[0], code: '', name: '', type: 'buy', price: '', quantity: '', fee: 0 },
                cash: { id: null, date: new Date().toISOString().split('T')[0], type: 'deposit', amount: '', note: '' },
                correction: { code: '', qty: '', avgCost: '' }
            });
            const [search, setSearch] = useState({ loading: false, results: [] });
            const [update, setUpdate] = useState({ loading: false, status: '' });
            const searchTimer = useRef(null);

            // 自動儲存
            useEffect(() => localStorage.setItem('stock_app_db', JSON.stringify(data)), [data]);

            // --- 核心計算 (Memoized) ---
            const stats = useMemo(() => {
                let inventory = {}, tradeIn = 0, tradeOut = 0;
                
                // 1. 交易計算
                [...data.trades].sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(t => {
                    const amt = Number(t.price) * Number(t.quantity);
                    const fee = Number(t.fee) || 0;
                    if(!inventory[t.code]) inventory[t.code] = { name: t.name, qty: 0, cost: 0, avg: 0 };
                    
                    if(t.type === 'buy') {
                        inventory[t.code].qty += Number(t.quantity);
                        inventory[t.code].cost += amt + fee;
                        inventory[t.code].name = t.name || t.code;
                        tradeOut += (amt + fee);
                    } else {
                        const costPer = inventory[t.code].qty > 0 ? inventory[t.code].cost / inventory[t.code].qty : 0;
                        inventory[t.code].qty -= Number(t.quantity);
                        inventory[t.code].cost -= costPer * Number(t.quantity);
                        tradeIn += (amt - fee);
                    }
                    inventory[t.code].avg = inventory[t.code].qty > 0.0001 ? inventory[t.code].cost / inventory[t.code].qty : 0;
                });

                // 2. 修正覆寫
                Object.entries(data.corrections).forEach(([k, v]) => {
                    if(inventory[k]) {
                        inventory[k].qty = Number(v.qty);
                        inventory[k].avg = Number(v.avgCost);
                        inventory[k].cost = inventory[k].qty * inventory[k].avg;
                    }
                });

                // 3. 資金計算
                let principal = 0;
                data.cashFlows.forEach(c => {
                    if(c.type === 'deposit') principal += Number(c.amount);
                    else if(c.type === 'withdraw') principal -= Number(c.amount);
                });

                // 4. 持倉列表
                const holdings = Object.entries(inventory)
                    .filter(([_, i]) => i.qty > 0.0001)
                    .map(([code, i]) => {
                        const price = data.prices[code] !== undefined ? data.prices[code] : i.avg;
                        const mktVal = price * i.qty;
                        return { ...i, code, price, mktVal, pl: mktVal - i.cost, roi: i.cost>0 ? (mktVal-i.cost)/i.cost*100 : 0 };
                    });

                // 5. 總結
                const stockVal = holdings.reduce((s, h) => s + h.mktVal, 0);
                const stockCost = holdings.reduce((s, h) => s + h.cost, 0);
                const rawCash = principal + tradeIn - tradeOut;
                const cash = Math.max(0, rawCash);
                const totalAssets = stockVal + cash;
                
                return {
                    holdings, principal, cash, stockVal, stockCost, totalAssets,
                    isReinvest: rawCash < 0, reinvestAmt: rawCash < 0 ? Math.abs(rawCash) : 0,
                    totalPL: totalAssets - principal,
                    totalROI: principal > 0 ? (totalAssets - principal)/principal*100 : 0,
                    stockPL: stockVal - stockCost,
                    stockROI: stockCost > 0 ? (stockVal - stockCost)/stockCost*100 : 0
                };
            }, [data]);

            // --- 功能函式 ---
            const fNum = n => new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
            const fInt = n => new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(n);

            // Yahoo 搜尋代理
            const searchStock = async (q) => {
                if(!q) return setSearch({loading:false, results:[]});
                setSearch(p => ({...p, loading:true}));
                try {
                    const res = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v1/finance/search?q=${q}&quotesCount=5`)}`);
                    const json = await res.json();
                    setSearch({ loading: false, results: json.quotes?.filter(x => x.isYahooFinance) || [] });
                } catch { setSearch({ loading: false, results: [] }); }
            };

            const handleCodeInput = (val) => {
                setForms(p => ({...p, trade: {...p.trade, code: val}}));
                if(searchTimer.current) clearTimeout(searchTimer.current);
                searchTimer.current = setTimeout(() => {
                    if(val.length > 1) searchStock(val); else setSearch({loading:false, results:[]});
                }, 600);
            };

            // 並行更新報價
            const updateAllPrices = async () => {
                setUpdate({loading:true, status:'準備中...'});
                const newPrices = {...data.prices};
                const codes = stats.holdings.map(h => h.code);
                
                for(let i=0; i<codes.length; i+=3) {
                    const batch = codes.slice(i, i+3);
                    setUpdate(p => ({...p, status: `更新 ${i+1}/${codes.length}`}));
                    await Promise.all(batch.map(async (code) => {
                        try {
                            const res = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${code}?interval=1d&range=1d`)}`);
                            const json = await res.json();
                            const p = json.chart?.result?.[0]?.meta?.regularMarketPrice;
                            if(p) newPrices[code] = p;
                        } catch {}
                    }));
                }
                setData(p => ({...p, prices: newPrices}));
                setUpdate({loading:false, status:''});
            };

            // --- 介面渲染 ---
            return (
                <div className="pb-safe-bottom min-h-screen">
                    {/* Header */}
                    <div className="bg-slate-900 px-5 pt-safe-top pb-4 rounded-b-3xl shadow-2xl border-b border-slate-800">
                        <div className="pt-2 grid grid-cols-2 gap-6 mb-4">
                            <div>
                                <div className="text-slate-400 text-[10px] font-bold mb-1 flex items-center gap-1"><Icon name="wallet" size={10}/> 資金總淨值 (Net)</div>
                                <div className="text-2xl font-bold tracking-tight">${fNum(stats.totalAssets)}</div>
                                <div className="mt-2 pt-2 border-t border-slate-800">
                                    <div className="text-[10px] text-slate-500 mb-0.5">vs 投入本金 ${fInt(stats.principal)}</div>
                                    <div className={`text-sm font-bold ${stats.totalPL >= 0 ? 'text-indigo-400' : 'text-slate-400'}`}>{stats.totalPL>=0?'+':''}{fInt(stats.totalPL)} <span className="text-xs">({stats.totalROI.toFixed(1)}%)</span></div>
                                </div>
                            </div>
                            <div className="pl-6 border-l border-slate-800">
                                <div className="text-slate-400 text-[10px] font-bold mb-1 flex items-center gap-1"><Icon name="pie" size={10}/> 股票市值 (Stock)</div>
                                <div className="text-2xl font-bold tracking-tight">${fNum(stats.stockVal)}</div>
                                <div className="mt-2 pt-2 border-t border-slate-800">
                                    <div className="text-[10px] text-slate-500 mb-0.5">vs 持倉成本 ${fInt(stats.stockCost)}</div>
                                    <div className={`text-sm font-bold ${stats.stockPL >= 0 ? 'text-red-400' : 'text-green-400'}`}>{stats.stockPL>=0?'+':''}{fInt(stats.stockPL)} <span className="text-xs">({stats.stockROI.toFixed(1)}%)</span></div>
                                </div>
                            </div>
                        </div>
                        <div className="flex justify-between items-center h-6">
                            {stats.isReinvest && <div className="bg-indigo-500/10 rounded-full px-2 py-0.5 flex items-center gap-1 border border-indigo-500/20"><Icon name="zap" size={10} className="text-indigo-400"/><span className="text-[9px] text-indigo-300">複利模式 (${fInt(stats.reinvestAmt)})</span></div>}
                            <div className="ml-auto flex items-center gap-1 text-[9px] text-emerald-400 bg-emerald-900/10 px-2 py-0.5 rounded-full border border-emerald-900/30"><Icon name="check" size={9}/> Ready</div>
                        </div>
                    </div>

                    {/* Tabs */}
                    <div className="flex px-2 mt-2 sticky top-0 bg-slate-950/90 z-30 backdrop-blur-md border-b border-slate-800/50">
                        {['portfolio', 'capital', 'transactions'].map(t => (
                            <button key={t} onClick={() => setTab(t)} className={`flex-1 py-3 text-xs font-bold text-center border-b-2 transition-colors ${tab === t ? 'border-indigo-500 text-indigo-400' : 'border-transparent text-slate-600'}`}>
                                {t === 'portfolio' ? '持倉' : t === 'capital' ? '資金' : '紀錄'}
                            </button>
                        ))}
                    </div>

                    {/* Content */}
                    <div className="p-4 space-y-4 pb-24">
                        {tab === 'portfolio' && (
                            <div className="space-y-4 animate-fade-in">
                                <button onClick={updateAllPrices} disabled={update.loading} className={`w-full border py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all active:scale-[0.98] ${update.loading ? 'bg-slate-800 border-slate-700 text-slate-500' : 'bg-slate-900 border-slate-800 text-indigo-400'}`}>
                                    <Icon name={update.loading ? "search" : "globe"} size={14} className={update.loading?"animate-spin":""} /> 
                                    {update.loading ? update.status : '更新所有現價 (Yahoo)'}
                                </button>
                                {stats.holdings.length === 0 && <div className="text-center py-20 text-slate-600 text-sm">暫無持倉，請新增交易</div>}
                                {stats.holdings.map(s => (
                                    <div key={s.code} className="bg-slate-900 p-4 rounded-xl border border-slate-800 relative group">
                                        <div className="flex justify-between items-start mb-3">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 rounded-lg bg-slate-800 text-slate-300 flex items-center justify-center font-bold text-sm border border-slate-700">{s.code.includes('.TW')?s.code.split('.')[0]:s.code.substring(0,2)}</div>
                                                <div className="overflow-hidden"><div className="font-bold text-base leading-none mb-1">{s.code}</div><div className="text-xs text-slate-500 truncate w-24">{s.name}</div></div>
                                            </div>
                                            <div className="flex items-center gap-1 bg-slate-950/50 px-2 py-1 rounded-lg border border-slate-800">
                                                <span className="text-xs text-slate-500">$</span>
                                                <input type="number" value={s.price} onChange={e => setData(p => ({...p, prices:{...p.prices, [s.code]: parseFloat(e.target.value)||0}}))} className={`bg-transparent text-right font-bold text-base w-20 outline-none ${s.price > s.avg ? 'text-red-400' : 'text-green-400'}`}/>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-3 gap-2 py-3 border-t border-slate-800/50 relative">
                                            <button onClick={() => { setForms(p=>({...p, correction: {code:s.code, qty:s.qty, avgCost:s.avg}})); setModal('correction'); }} className="absolute top-2 right-0 p-2 text-slate-600 z-10"><Icon name="edit" size={14}/></button>
                                            <div><div className="text-[10px] text-slate-500">股數</div><div className="text-sm font-medium text-slate-300">{fNum(s.qty)}</div></div>
                                            <div className="text-center"><div className="text-[10px] text-slate-500">均價</div><div className="text-sm font-medium text-slate-300">${fNum(s.avg)}</div></div>
                                            <div className="text-right"><div className="text-[10px] text-slate-500">成本</div><div className="text-sm font-medium text-slate-300">${fInt(s.cost)}</div></div>
                                        </div>
                                        <div className="flex justify-between items-center bg-slate-950/30 p-2.5 rounded-lg mt-1 border border-slate-800/30">
                                            <div className="text-xs text-slate-400">未實現損益</div>
                                            <div className={`text-sm font-bold flex gap-2 ${s.pl >= 0 ? 'text-red-400' : 'text-green-400'}`}><span>{s.pl>=0?'+':''}{fInt(s.pl)}</span><span className="text-xs px-1.5 py-0.5 rounded bg-white/5">{s.roi.toFixed(1)}%</span></div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {tab === 'capital' && (
                            <div className="space-y-4 animate-fade-in">
                                <div className="bg-gradient-to-r from-slate-900 to-slate-800 p-4 rounded-xl border border-slate-800 flex justify-between items-center shadow-lg">
                                    <div><div className="text-slate-400 text-xs mb-1">{stats.isReinvest?'可用現金 (全額投入)':'目前現金餘額'}</div><div className={`text-2xl font-bold ${stats.isReinvest?'text-slate-500':'text-white'}`}>${fNum(stats.cash)}</div></div>
                                    <button onClick={()=>{setForms(p=>({...p, cash:{...p.cash, amount:''}})); setModal('cash')}} className="bg-indigo-600 text-white px-3 py-2 rounded-lg text-xs font-bold flex gap-1.5"><Icon name="plus" size={14}/> 資金異動</button>
                                </div>
                                <div className="space-y-2">
                                    {[...data.cashFlows].sort((a,b)=>new Date(b.date)-new Date(a.date)).map(f => (
                                        <div key={f.id} className="bg-slate-900 p-3 rounded-lg flex justify-between items-center border border-slate-800">
                                            <div className="flex items-center gap-3">
                                                <div className={`p-2 rounded-full ${f.type==='deposit'?'bg-blue-500/10 text-blue-400':'bg-orange-500/10 text-orange-400'}`}>{f.type==='deposit'?<Icon name="in" size={18}/>:<Icon name="out" size={18}/>}</div>
                                                <div><div className="text-sm font-bold">{f.type==='deposit'?'入金':'出金'}</div><div className="text-xs text-slate-500">{f.date} {f.note}</div></div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <div className={`font-mono font-bold ${f.type==='deposit'?'text-blue-400':'text-orange-400'}`}>{f.type==='withdraw'?'-':'+'}{fNum(f.amount)}</div>
                                                <button onClick={()=>confirm('刪除？')&&setData(p=>({...p, cashFlows:p.cashFlows.filter(x=>x.id!==f.id)}))} className="p-2 text-slate-500"><Icon name="trash" size={14}/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {tab === 'transactions' && (
                            <div className="space-y-4 animate-fade-in">
                                <button onClick={()=>setModal('trade')} className="w-full bg-slate-900 border border-slate-700 border-dashed text-indigo-400 py-3 rounded-xl text-sm font-bold flex justify-center gap-2"><Icon name="plus" size={16}/> 新增交易</button>
                                <div className="space-y-2">
                                    {[...data.trades].sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t => (
                                        <div key={t.id} className="bg-slate-900 p-3 rounded-lg border border-slate-800 flex justify-between items-center">
                                            <div className="flex gap-3">
                                                <div className={`text-[10px] font-bold px-2 py-1 rounded h-fit mt-0.5 w-12 text-center ${t.type==='buy'?'bg-red-500/10 text-red-400':'bg-green-500/10 text-green-400'}`}>{t.type==='buy'?'BUY':'SELL'}</div>
                                                <div><div className="font-bold">{t.code}</div><div className="text-xs text-slate-500">{t.date}</div></div>
                                            </div>
                                            <div className="text-right flex items-center gap-3">
                                                <div><div className="text-sm font-bold">${fNum(t.price * t.quantity)}</div><div className="text-xs text-slate-500">${fNum(t.price)} x {fNum(t.quantity)}</div></div>
                                                <button onClick={()=>confirm('刪除？')&&setData(p=>({...p, trades:p.trades.filter(x=>x.id!==t.id)}))} className="p-2 text-slate-500"><Icon name="trash" size={14}/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Modals - Trade */}
                    {modal === 'trade' && (
                        <div className="fixed inset-0 z-50 flex items-end justify-center sm:items-center p-0 sm:p-4 animate-fade-in">
                            <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={()=>setModal(null)}></div>
                            <div className="bg-slate-900 w-full max-w-md rounded-t-2xl sm:rounded-2xl border-t sm:border border-slate-800 overflow-hidden shadow-2xl animate-slide-up relative z-10">
                                <div className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900"><h3 className="font-bold">新增交易</h3><button onClick={()=>setModal(null)}><Icon name="x" className="text-slate-400"/></button></div>
                                <div className="p-5 space-y-5">
                                    <div className="flex bg-slate-800/50 p-1 rounded-xl">
                                        <button onClick={()=>setForms(p=>({...p, trade:{...p.trade, type:'buy'}}))} className={`flex-1 py-2 text-sm font-bold rounded-lg ${forms.trade.type==='buy'?'bg-red-500':'text-slate-400'}`}>買入</button>
                                        <button onClick={()=>setForms(p=>({...p, trade:{...p.trade, type:'sell'}}))} className={`flex-1 py-2 text-sm font-bold rounded-lg ${forms.trade.type==='sell'?'bg-green-500':'text-slate-400'}`}>賣出</button>
                                    </div>
                                    <div className="relative">
                                        <div className="absolute left-3 top-3.5 text-slate-500"><Icon name="search" size={18}/></div>
                                        <input type="text" placeholder="代號 (如 AAPL, 2330)" value={forms.trade.code} onChange={e=>handleCodeInput(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 pl-10 text-white outline-none focus:border-indigo-500 uppercase"/>
                                        {search.loading && <div className="absolute right-3 top-3.5 animate-spin"><Icon name="pie" size={18}/></div>}
                                        {search.results.length > 0 && <ul className="absolute top-full w-full mt-1 bg-slate-800 border border-slate-700 rounded-xl shadow-xl z-50 max-h-48 overflow-y-auto">{search.results.map((s,i)=><li key={i} onClick={()=>{setForms(p=>({...p, trade:{...p.trade, code:s.symbol, name:s.shortname}})); setSearch({loading:false, results:[]})}} className="p-3 hover:bg-slate-700 flex justify-between"><span className="font-bold">{s.symbol}</span><span className="text-xs text-slate-400">{s.exchDisp}</span></li>)}</ul>}
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="text-xs text-slate-500 ml-1">單價</label><input type="number" value={forms.trade.price} onChange={e=>setForms(p=>({...p, trade:{...p.trade, price:e.target.value}}))} className="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-white outline-none"/></div>
                                        <div><label className="text-xs text-slate-500 ml-1">股數</label><input type="number" value={forms.trade.quantity} onChange={e=>setForms(p=>({...p, trade:{...p.trade, quantity:e.target.value}}))} className="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-white outline-none"/></div>
                                    </div>
                                    <button onClick={()=>{setData(p=>({...p, trades:[...p.trades, {id:Date.now(), ...forms.trade}]})); setModal(null);}} className="w-full bg-indigo-600 py-3.5 rounded-xl font-bold mt-2">確認</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modals - Cash */}
                    {modal === 'cash' && (
                        <div className="fixed inset-0 z-50 flex items-end justify-center sm:items-center p-0 sm:p-4 animate-fade-in"><div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={()=>setModal(null)}></div><div className="bg-slate-900 w-full max-w-md rounded-t-2xl sm:rounded-2xl border-t sm:border border-slate-800 overflow-hidden shadow-2xl animate-slide-up relative z-10"><div className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900"><h3 className="font-bold">資金異動</h3><button onClick={()=>setModal(null)}><Icon name="x" className="text-slate-400"/></button></div><div className="p-5 space-y-5"><div className="flex bg-slate-800/50 p-1 rounded-xl"><button onClick={()=>setForms(p=>({...p, cash:{...p.cash, type:'deposit'}}))} className={`flex-1 py-2 text-sm font-bold rounded-lg ${forms.cash.type==='deposit'?'bg-blue-600':'text-slate-400'}`}>入金</button><button onClick={()=>setForms(p=>({...p, cash:{...p.cash, type:'withdraw'}}))} className={`flex-1 py-2 text-sm font-bold rounded-lg ${forms.cash.type==='withdraw'?'bg-orange-600':'text-slate-400'}`}>出金</button></div><input type="number" placeholder="金額" value={forms.cash.amount} onChange={e=>setForms(p=>({...p, cash:{...p.cash, amount:e.target.value}}))} className="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-white outline-none"/><input type="text" placeholder="備註" value={forms.cash.note} onChange={e=>setForms(p=>({...p, cash:{...p.cash, note:e.target.value}}))} className="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-white outline-none"/><button onClick={()=>{setData(p=>({...p, cashFlows:[...p.cashFlows, {id:Date.now(), ...forms.cash}]})); setModal(null)}} className="w-full bg-indigo-600 py-3.5 rounded-xl font-bold mt-2">確認</button></div></div></div>
                    )}

                    {/* Modals - Correction */}
                    {modal === 'correction' && (
                        <div className="fixed inset-0 z-50 flex items-end justify-center sm:items-center p-0 sm:p-4 animate-fade-in"><div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={()=>setModal(null)}></div><div className="bg-slate-900 w-full max-w-md rounded-t-2xl sm:rounded-2xl border-t sm:border border-slate-800 overflow-hidden shadow-2xl animate-slide-up relative z-10"><div className="p-4 border-b border-slate-800 flex justify-between items-center"><h3 className="font-bold flex items-center gap-2"><Icon name="edit" size={18}/> 修正持倉</h3><button onClick={()=>setModal(null)}><Icon name="x" className="text-slate-400"/></button></div><div className="p-5 space-y-5"><div className="flex justify-between items-center bg-slate-800 p-2 rounded-lg"><span className="text-slate-400 text-sm">目標</span><span className="font-bold">{forms.correction.code}</span></div><div className="space-y-1"><label className="text-xs text-slate-500">修正後股數</label><input type="number" step="0.01" value={forms.correction.qty} onChange={e=>setForms(p=>({...p, correction:{...p.correction, qty:e.target.value}}))} className="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-white outline-none"/></div><div className="space-y-1"><label className="text-xs text-slate-500">修正後平均成本</label><input type="number" step="0.01" value={forms.correction.avgCost} onChange={e=>setForms(p=>({...p, correction:{...p.correction, avgCost:e.target.value}}))} className="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-white outline-none"/></div><button onClick={()=>{setData(p=>({...p, corrections:{...p.corrections, [forms.correction.code]:{qty:forms.correction.qty, avgCost:forms.correction.avgCost}}})); setModal(null)}} className="w-full bg-yellow-600 py-3.5 rounded-xl font-bold mt-2">確認修正</button></div></div></div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


